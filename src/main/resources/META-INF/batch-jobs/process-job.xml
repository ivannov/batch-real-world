<job id="process-job" xmlns="http://xmlns.jcp.org/xml/ns/javaee" version="1.0">

    <step id="moveFileStep" next="processFileFlow">
        <batchlet ref="moveFileBatchlet">
            <properties>
                <property name="fileToProcess" value="#{jobParameters['fileToProcess']}"/>
                <property name="companyId" value="#{jobParameters['companyId']}"/>
            </properties>
        </batchlet>
    </step>

    <flow id="processFileFlow">
        <step id="fileValidationStep">
            <batchlet ref="validationFileBatchlet">
                <properties>
                    <property name="fileToProcess" value="#{jobParameters['fileToProcess']}"/>
                    <property name="companyId" value="#{jobParameters['companyId']}"/>
                </properties>
            </batchlet>
            <next on="ERROR" to="processInvalidFileStep"/>
            <next on="*" to="processFileStep"/>
        </step>

        <step id="processFileStep">
            <chunk item-count="10">
                <reader ref="fileItemReader">
                    <properties>
                        <property name="fileToProcess" value="#{jobParameters['fileToProcess']}"/>
                        <property name="companyId" value="#{jobParameters['companyId']}"/>
                    </properties>
                </reader>
                <processor ref="fileItemProcessor">
                    <properties>
                        <property name="fileToProcess" value="#{jobParameters['fileToProcess']}"/>
                        <property name="companyId" value="#{jobParameters['companyId']}"/>
                    </properties>
                </processor>
                <writer ref="fileItemWriter"/>
            </chunk>
        </step>

        <step id="processInvalidFileStep">
            <batchlet ref="processInvalidFileBatchlet">
                <properties>
                    <property name="fileToProcess" value="#{jobParameters['fileToProcess']}"/>
                    <property name="companyId" value="#{jobParameters['companyId']}"/>
                </properties>
            </batchlet>
        </step>
    </flow>
</job>
